<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="alarm">

    <!-- ==================== 큐 관리 ==================== -->

    <!-- 큐 조회 (PENDING 상태) -->
    <select id="selectPendingQueue" parameterType="map" resultType="map">
        SELECT QUEUE_ID,
               MAIL_SOURCE,
               ALARM_NAME,
               SEVERITY,
               SQL_ID,
               SECTION_TITLE,
               SECTION_CONTENT,
               RECIPIENT_USER_IDS,
               RECIPIENT_GROUPS,
               COLUMN_ORDER,
               STATUS,
               RETRY_COUNT,
               ERROR_MESSAGE,
               REG_DATE
        FROM MAIL_QUEUE
        WHERE STATUS = 'PENDING'
        ORDER BY REG_DATE ASC<if test="LIMIT != null">
        FETCH FIRST #{LIMIT} ROWS ONLY</if>
    </select>

    <!-- 큐 상태 업데이트: SUCCESS -->
    <update id="updateQueueSuccess" parameterType="map">
        UPDATE MAIL_QUEUE
        SET STATUS = 'SUCCESS',
            UPD_DATE = SYSDATE
        WHERE QUEUE_ID = #{QUEUE_ID}
    </update>

    <!-- 큐 상태 업데이트: RETRY -->
    <update id="updateQueueRetry" parameterType="map">
        UPDATE MAIL_QUEUE
        SET RETRY_COUNT = RETRY_COUNT + 1,
            ERROR_MESSAGE = #{ERROR_MESSAGE},
            UPD_DATE = SYSDATE
        WHERE QUEUE_ID = #{QUEUE_ID}
    </update>

    <!-- 큐 상태 업데이트: FAILED -->
    <update id="updateQueueFailed" parameterType="map">
        UPDATE MAIL_QUEUE
        SET STATUS = 'FAILED',
            ERROR_MESSAGE = #{ERROR_MESSAGE},
            UPD_DATE = SYSDATE
        WHERE QUEUE_ID = #{QUEUE_ID}
    </update>

    <!-- 큐 정리 (완료된 항목 삭제) -->
    <delete id="deleteCompletedQueue">
        DELETE FROM MAIL_QUEUE
        WHERE STATUS IN ('SUCCESS', 'FAILED')
          AND REG_DATE <![CDATA[<]]> SYSDATE - 7
    </delete>


    <!-- ==================== Consumer가 호출할 Detail 쿼리 (SQL_ID) ==================== -->

    <!-- 지연 주문 상세 조회 -->
    <select id="selectOverdueOrdersDetail" resultType="map">
        SELECT ORDER_ID,
               CUSTOMER_NAME AS CUSTOMER,
               TO_CHAR(ORDER_DATE, 'YYYY-MM-DD') AS ORDER_DATE,
               DAYS_OVERDUE
        FROM ORDERS
        WHERE STATUS = 'OVERDUE'
          AND DAYS_OVERDUE <![CDATA[>=]]> 5
        ORDER BY DAYS_OVERDUE DESC
    </select>

    <!-- 재고 부족 상세 조회 -->
    <select id="selectLowStockDetail" resultType="map">
        SELECT WAREHOUSE_CODE,
               PRODUCT_CODE,
               PRODUCT_NAME,
               STOCK_QTY      AS CURRENT_STOCK,
               MIN_STOCK_QTY  AS MIN_STOCK
        FROM INVENTORY
        WHERE STOCK_QTY <![CDATA[<]]> MIN_STOCK_QTY
        ORDER BY STOCK_QTY ASC
    </select>


    <!-- ==================== 사용자 조회 ==================== -->

    <!-- ADM 그룹 사용자 조회 -->
    <select id="selectAdmGroup" resultType="map">
        SELECT USER_ID,
               USER_NAME,
               EMAIL,
               USER_GROUP
        FROM USER_INFO
        WHERE USER_GROUP = 'ADM'
          AND EMAIL IS NOT NULL
        ORDER BY USER_NAME
    </select>

    <!-- 특정 그룹 사용자 조회 -->
    <select id="selectUsersByGroup" parameterType="string" resultType="map">
        SELECT USER_ID,
               USER_NAME,
               EMAIL,
               USER_GROUP
        FROM USER_INFO
        WHERE USER_GROUP = #{USER_GROUP}
          AND EMAIL IS NOT NULL
        ORDER BY USER_NAME
    </select>

    <!-- 수신인 통합 조회 (사용자 ID + 그룹, DISTINCT로 중복 제거) -->
    <select id="selectRecipientsByConditions" parameterType="map" resultType="map">
        SELECT DISTINCT
               EMAIL,
               USER_ID,
               USER_NAME,
               USER_GROUP
        FROM USER_INFO
        WHERE EMAIL IS NOT NULL
        <if test="USER_IDS != null or GROUPS != null">
          AND (
            <if test="USER_IDS != null and USER_IDS.size() > 0">
                USER_ID IN
                <foreach collection="USER_IDS" item="USER_ID" open="(" separator="," close=")">
                    #{USER_ID}
                </foreach>
            </if>
            <if test="USER_IDS != null and USER_IDS.size() > 0 and GROUPS != null and GROUPS.size() > 0">
                OR
            </if>
            <if test="GROUPS != null and GROUPS.size() > 0">
                USER_GROUP IN
                <foreach collection="GROUPS" item="GROUP" open="(" separator="," close=")">
                    #{GROUP}
                </foreach>
            </if>
          )
        </if>
        ORDER BY USER_NAME
    </select>

</mapper>