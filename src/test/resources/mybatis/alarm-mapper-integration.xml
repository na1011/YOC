<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="alarm">

    <!-- ==================== 통합 테스트용 쿼리 ==================== -->

    <!-- ==================== 큐 관리 (main과 동일) ==================== -->

    <!-- 큐 조회 (PENDING 상태) -->
    <select id="selectPendingQueue" parameterType="map" resultType="map">
        SELECT QUEUE_ID,
               MAIL_SOURCE,
               ALARM_NAME,
               SEVERITY,
               SQL_ID,
               SECTION_TITLE,
               SECTION_CONTENT,
               RECIPIENT_USER_IDS,
               RECIPIENT_GROUPS,
               COLUMN_ORDER,
               STATUS,
               RETRY_COUNT,
               ERROR_MESSAGE,
               REG_DATE
        FROM MAIL_QUEUE
        WHERE STATUS = 'PENDING'
        ORDER BY REG_DATE ASC<if test="LIMIT != null">
        FETCH FIRST ${LIMIT} ROWS ONLY</if>
    </select>

    <!-- 큐 상태 업데이트: SUCCESS -->
    <update id="updateQueueSuccess" parameterType="map">
        UPDATE MAIL_QUEUE
        SET STATUS = 'SUCCESS',
            UPD_DATE = SYSDATE
        WHERE QUEUE_ID = #{QUEUE_ID}
    </update>

    <!-- 큐 상태 업데이트: RETRY -->
    <update id="updateQueueRetry" parameterType="map">
        UPDATE MAIL_QUEUE
        SET RETRY_COUNT = RETRY_COUNT + 1,
            ERROR_MESSAGE = #{ERROR_MESSAGE},
            UPD_DATE = SYSDATE
        WHERE QUEUE_ID = #{QUEUE_ID}
    </update>

    <!-- 큐 상태 업데이트: FAILED -->
    <update id="updateQueueFailed" parameterType="map">
        UPDATE MAIL_QUEUE
        SET STATUS = 'FAILED',
            ERROR_MESSAGE = #{ERROR_MESSAGE},
            UPD_DATE = SYSDATE
        WHERE QUEUE_ID = #{QUEUE_ID}
    </update>


    <!-- ==================== Consumer가 호출할 Detail 쿼리 (SQL_ID) ==================== -->

    <!-- 지연 주문 상세 조회 -->
    <select id="selectOverdueOrdersDetail" resultType="map">
        SELECT ORDER_ID,
               CUSTOMER_NAME AS CUSTOMER,
               TO_CHAR(ORDER_DATE, 'YYYY-MM-DD') AS ORDER_DATE,
               DAYS_OVERDUE
        FROM ORDERS
        WHERE STATUS = 'DELAYED'
          AND DAYS_OVERDUE >= 3
        ORDER BY DAYS_OVERDUE DESC
    </select>

    <!-- 재고 부족 상세 조회 -->
    <select id="selectLowStockDetail" resultType="map">
        SELECT WAREHOUSE_CODE,
               PRODUCT_CODE,
               PRODUCT_NAME,
               STOCK_QTY      AS CURRENT_STOCK,
               MIN_STOCK_QTY  AS MIN_STOCK
        FROM INVENTORY
        WHERE STOCK_QTY &lt; MIN_STOCK_QTY
        ORDER BY STOCK_QTY ASC
    </select>


    <!-- ==================== 사용자 조회 (main과 동일) ==================== -->

    <!-- ADM 그룹 사용자 조회 -->
    <select id="selectAdmGroup" resultType="map">
        SELECT USER_ID,
               USER_NAME,
               EMAIL,
               USER_GROUP
        FROM USER_INFO
        WHERE USER_GROUP = 'ADM'
          AND EMAIL IS NOT NULL
        ORDER BY USER_NAME
    </select>

    <!-- 수신인 통합 조회 (main과 동일) -->
    <select id="selectRecipientsByConditions" parameterType="map" resultType="map">
        SELECT DISTINCT
               EMAIL,
               USER_ID,
               USER_NAME,
               USER_GROUP
        FROM USER_INFO
        WHERE EMAIL IS NOT NULL
        <if test="USER_IDS != null or GROUPS != null">
          AND (
            <if test="USER_IDS != null and USER_IDS.size() > 0">
                USER_ID IN
                <foreach collection="USER_IDS" item="USER_ID" open="(" separator="," close=")">
                    #{USER_ID}
                </foreach>
            </if>
            <if test="USER_IDS != null and USER_IDS.size() > 0 and GROUPS != null and GROUPS.size() > 0">
                OR
            </if>
            <if test="GROUPS != null and GROUPS.size() > 0">
                USER_GROUP IN
                <foreach collection="GROUPS" item="GROUP" open="(" separator="," close=")">
                    #{GROUP}
                </foreach>
            </if>
          )
        </if>
        ORDER BY USER_NAME
    </select>


    <!-- ==================== 테스트 전용 쿼리 ==================== -->

    <!-- 테스트용 큐 강제 삽입 (Producer 시뮬레이션) -->
    <insert id="insertTestQueue" parameterType="map">
        INSERT INTO MAIL_QUEUE (
            QUEUE_ID, MAIL_SOURCE, ALARM_NAME, SEVERITY,
            SQL_ID, SECTION_TITLE, SECTION_CONTENT, COLUMN_ORDER,
            RECIPIENT_USER_IDS, RECIPIENT_GROUPS,
            STATUS, RETRY_COUNT, REG_DATE
        ) VALUES (
            NEXT VALUE FOR SEQ_MAIL_QUEUE,
            #{MAIL_SOURCE}, #{ALARM_NAME}, #{SEVERITY},
            #{SQL_ID}, #{SECTION_TITLE}, #{SECTION_CONTENT}, #{COLUMN_ORDER},
            #{RECIPIENT_USER_IDS, jdbcType=VARCHAR}, #{RECIPIENT_GROUPS, jdbcType=VARCHAR},
            'PENDING', #{RETRY_COUNT, jdbcType=INTEGER}, SYSDATE
        )
    </insert>

    <!-- 특정 큐 조회 (검증용) - Map 구조: QUEUE_ID, MAIL_SOURCE, STATUS, RETRY_COUNT, ERROR_MESSAGE 등 -->
    <select id="selectQueueById" parameterType="long" resultType="map">
        SELECT QUEUE_ID,
               MAIL_SOURCE,
               ALARM_NAME,
               SEVERITY,
               SQL_ID,
               SECTION_TITLE,
               SECTION_CONTENT,
               RECIPIENT_USER_IDS,
               RECIPIENT_GROUPS,
               STATUS,
               RETRY_COUNT,
               ERROR_MESSAGE,
               REG_DATE,
               UPD_DATE
        FROM MAIL_QUEUE
        WHERE QUEUE_ID = #{QUEUE_ID}
    </select>

    <!-- 특정 MAIL_SOURCE의 큐 조회 (중복 방지 검증용) -->
    <select id="selectQueueByMailSource" parameterType="string" resultType="map">
        SELECT QUEUE_ID,
               MAIL_SOURCE,
               STATUS,
               RETRY_COUNT,
               REG_DATE
        FROM MAIL_QUEUE
        WHERE MAIL_SOURCE = #{MAIL_SOURCE}
        ORDER BY REG_DATE DESC
    </select>

    <!-- 큐 전체 삭제 (테스트 초기화) -->
    <delete id="deleteAllQueue">
        DELETE FROM MAIL_QUEUE
    </delete>

    <!-- 빈 데이터 쿼리 (시나리오 8용 - 테이블 섹션 생략 검증) -->
    <select id="selectNonExistentData" resultType="map">
        SELECT ORDER_ID,
               CUSTOMER_NAME AS CUSTOMER
        FROM ORDERS
        WHERE 1=0
    </select>

</mapper>